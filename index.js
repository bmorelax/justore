var Immutable = require('immutable');var EventEmitter = require('eventemitter3');var isPromise = require('is-promise');function Justore(initData,storeName) {	var self = this;	self.name = storeName || 'Anonymous Store';	var data = Immutable.Map(initData || {});	var previousData = data;	function triggerChange(){		data.forEach(function(itemData,key){			var prevItemData = previousData.get(key);			if(itemData !== prevItemData){				self.change.emit(key,itemData,prevItemData);				return false;			}		})	}	function updatePreviousData(){		previousData = data;	}	this.write = function (key, d, waitForPromise) {		function triggerReject(reson){			self.change.emit('Error:'+key,reson);			console.warn('Justore write '+ self.name +' Error: ',reson);		}		var setData = function(d){			updatePreviousData();			data = data.set(key, d);			return Promise.resolve(data);		};		if(isPromise(waitForPromise)){			return waitForPromise				.then(setData)				.then(triggerChange,triggerReject);		}else{			return setData(d)				.then(triggerChange,triggerReject)		}	};	this.read = function(key){		return key ? data.get(key) : data;	}}Justore.prototype.change = new EventEmitter();module.exports = Justore;